<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Presenter</title>
  <link rel="stylesheet" href="css/custom.css">
</head>
<body>
  <div class="dashboard">
    <h1>Presenter</h1>
    <p class="subtitle">Presentation solution with mobile remote control</p>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <h2 style="margin-bottom:0;">Presentations</h2>
        <a class="btn btn-sm" href="/builder.html">+ Create New</a>
      </div>
      <ul class="pres-list" id="pres-list">
        <li><span class="name">Loading...</span></li>
      </ul>
    </div>

    <div class="card">
      <h2>Connect</h2>
      <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:1rem;">Share these links with your audience and use the remote on your phone.</p>
      <div class="qr-section" id="qr-section">
        <div class="qr-item">
          <p><strong>Remote Control</strong></p>
          <div id="qr-remote" style="width:180px;height:180px;display:flex;align-items:center;justify-content:center;background:var(--surface);border-radius:8px;"><span style="color:var(--text-muted);font-size:0.8rem;">Generating...</span></div>
          <p class="url" id="url-remote"></p>
        </div>
        <div class="qr-item">
          <p><strong>Audience View</strong></p>
          <div id="qr-audience" style="width:180px;height:180px;display:flex;align-items:center;justify-content:center;background:var(--surface);border-radius:8px;"><span style="color:var(--text-muted);font-size:0.8rem;">Generating...</span></div>
          <p class="url" id="url-audience"></p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="js/supabase-client.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script>
    // Load presentations from Supabase
    async function loadPresentations() {
      const list = document.getElementById('pres-list');
      try {
        const presentations = await PresentationsDB.list();

        if (presentations.length === 0) {
          list.innerHTML = '<li><span class="name" style="color:var(--text-muted)">No presentations yet. Click "+ Create New" to get started.</span></li>';
          return;
        }

        list.innerHTML = presentations.map(p => {
          const editBtn = p.type === 'deck'
            ? `<a class="btn btn-sm btn-outline" href="/builder.html?file=${encodeURIComponent(p.filename)}">Edit</a>`
            : '';
          return `<li>
            <span class="name">${p.name}</span>
            <span style="display:flex;gap:0.5rem;align-items:center;">
              <span class="type">${p.type}</span>
              ${editBtn}
              <a class="btn btn-sm" href="/slides.html?file=${encodeURIComponent(p.filename)}">Present</a>
              <a class="btn btn-sm btn-outline" href="/presenter.html">Speaker View</a>
            </span>
          </li>`;
        }).join('');
      } catch (e) {
        list.innerHTML = `<li><span class="name" style="color:var(--danger)">Error loading: ${e.message}</span></li>`;
      }
    }

    // Generate QR codes client-side
    async function generateQR() {
      const base = window.location.origin;
      const remoteUrl = `${base}/remote.html`;
      const audienceUrl = `${base}/audience.html`;

      try {
        const remoteQR = await QRCode.toDataURL(remoteUrl, { width: 180, margin: 1, color: { dark: '#000', light: '#fff' } });
        const audienceQR = await QRCode.toDataURL(audienceUrl, { width: 180, margin: 1, color: { dark: '#000', light: '#fff' } });

        document.getElementById('qr-remote').innerHTML = `<img src="${remoteQR}" alt="QR Remote" width="180" height="180" style="border-radius:8px;">`;
        document.getElementById('url-remote').textContent = remoteUrl;

        document.getElementById('qr-audience').innerHTML = `<img src="${audienceQR}" alt="QR Audience" width="180" height="180" style="border-radius:8px;">`;
        document.getElementById('url-audience').textContent = audienceUrl;
      } catch (e) {
        console.error('QR generation error:', e);
      }
    }

    loadPresentations();
    generateQR();
  </script>
</body>
</html>
